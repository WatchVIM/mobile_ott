<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WatchVIM Universal</title>

  <!-- Tailwind (same theme + colors as website) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            watchBlack: "#0a0a0a",
            watchRed: "#e50914",
            watchGold: "#d4af37"
          }
        }
      }
    }
  </script>

  <!-- Mux Player -->
  <script src="https://unpkg.com/@mux/mux-player@latest"></script>

  <!-- Optional IMA SDK for VAST -->
  <script src="https://imasdk.googleapis.com/js/sdkloader/ima3.js"></script>

  <style>
    html, body { height:100%; background:#0a0a0a; color:#fff; margin:0; }
    .no-scrollbar::-webkit-scrollbar { display:none; }
    .no-scrollbar { -ms-overflow-style:none; scrollbar-width:none; }
    .line-clamp-1,.line-clamp-2,.line-clamp-3{
      display:-webkit-box;-webkit-box-orient:vertical;overflow:hidden;
    }
    .line-clamp-1{-webkit-line-clamp:1;}
    .line-clamp-2{-webkit-line-clamp:2;}
    .line-clamp-3{-webkit-line-clamp:3;}
    .focus-ring{ outline:3px solid #e50914; outline-offset:2px; border-radius:12px; }
    .safe-bottom{ padding-bottom: env(safe-area-inset-bottom); }
  </style>
</head>

<body class="bg-watchBlack text-white">
  <div id="app"></div>

  <script>
  // =========================================================
  // WatchVIM Universal App (Mobile + TV)
  // - Syncs with Website via SAME Manifest/Catalog
  // =========================================================
  (() => {
    // ---------- Config ----------
    const DEFAULT_CONFIG = {
      MANIFEST_URL: "https://t6ht6kdwnezp05ut.public.blob.vercel-storage.com/manifest.json",
      CATALOG_URL_FALLBACK: "https://t6ht6kdwnezp05ut.public.blob.vercel-storage.com/catalog.json",
      LOGO_URL: "https://t6ht6kdwnezp05ut.public.blob.vercel-storage.com/WatchVIM%20-%20Content/WatchVIM_New_OTT_Logo.png",

      SUPABASE_URL: "",
      SUPABASE_ANON_KEY: "",

      PAYPAL_CLIENT_ID: "",
      PAYPAL_CURRENCY: "USD",

      VAST_TAG: ""
    };
    let CONFIG = { ...DEFAULT_CONFIG };
    let supabase = null;

    const state = {
      catalog: null,
      titles: [],
      byId: new Map(),
      activeTab: "Movies",
      route: { name:"home", params:{} },
      session: null,
      user: null,
      loop: { queue:[], index:0, lastAdAt:0, shuffle:true, playingAd:false }
    };

    const TAB_FILTERS = {
      Movies: (t)=> t.type==="films" || t.type==="documentaries",
      Series: (t)=> t.type==="series",
      Shorts: (t)=> t.type==="shorts" || (t.runtimeMins && Number(t.runtimeMins)<=40),
      Foreign: (t)=>
        t.type==="foreign" ||
        (t.genre||[]).some(g=>/foreign|international|world/i.test(g)) ||
        (t.language && !/english/i.test(t.language)),
      LIVE: ()=>false
    };

    // ---------- Utils ----------
    const $app = () => document.getElementById("app");
    const esc = (s="") => String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
    const toMins = (x)=> Number.isFinite(Number(x)) ? Number(x) : "";
    const poster = (t)=> t.posterUrl || t.appImages?.tvPosterUrl || t.appImages?.mobilePosterUrl || "";
    const hero   = (t)=> t.heroUrl   || t.appImages?.tvHeroUrl   || t.appImages?.mobileHeroUrl   || poster(t) || "";
    const typeLabel = (type)=>{
      const map={films:"Movie",documentaries:"Documentary",series:"Series",shorts:"Short",foreign:"Foreign"};
      return map[type]||type||"Title";
    };
    const navTo = (hash)=> location.hash = hash;

    function isTV(){
      const ua = navigator.userAgent.toLowerCase();
      return ua.includes("aft") || ua.includes("smarttv") || ua.includes("tizen") ||
             ua.includes("webos") || ua.includes("android tv") ||
             window.innerWidth >= 1024;
    }

    // ---------- Local progress ----------
    function readLastWatched(){
      try { return JSON.parse(localStorage.getItem("watchvim_last_watched")||"[]"); }
      catch { return []; }
    }
    function saveLastWatched(items){
      localStorage.setItem("watchvim_last_watched", JSON.stringify(items.slice(0,20)));
    }
    function markWatched(titleId, progress=0){
      const items = readLastWatched().filter(x=>x.titleId!==titleId);
      items.unshift({ titleId, progress, at: Date.now() });
      saveLastWatched(items);
    }
    function shuffleArray(arr){
      const a=arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    // ---------- Config loading ----------
    async function loadConfigJSON(){
      try{
        const res = await fetch("/config.json?t="+Date.now(),{cache:"no-store"});
        if(!res.ok) return;
        const json = await res.json();
        CONFIG = { ...CONFIG, ...json };
      }catch{}
    }

    // ---------- Data loading (same as website) ----------
    async function fetchCatalogFromManifest(){
      try{
        const mRes = await fetch(CONFIG.MANIFEST_URL+"?t="+Date.now(),{cache:"no-store"});
        if(!mRes.ok) throw new Error("Manifest fetch failed");
        const manifest = await mRes.json();

        const catalogUrl =
          manifest.latestCatalogUrl ||
          manifest.catalogUrl ||
          CONFIG.CATALOG_URL_FALLBACK;

        const cRes = await fetch(catalogUrl+"?t="+Date.now(),{cache:"no-store"});
        if(!cRes.ok) throw new Error("Catalog fetch failed");
        return await cRes.json();
      }catch(e){
        const cRes = await fetch(CONFIG.CATALOG_URL_FALLBACK+"?t="+Date.now(),{cache:"no-store"});
        if(!cRes.ok) throw e;
        return await cRes.json();
      }
    }

    function normalizeCatalog(catalog){
      const titles = catalog.titles || catalog.publishedTitles || [];
      const byId = new Map();

      titles.forEach(t=>{
        byId.set(t.id,t);
        if(t.type==="series"){
          (t.seasons||[]).forEach((s,si)=>{
            (s.episodes||[]).forEach((ep,ei)=>{
              if(!ep.id) ep.id = `${t.id}_s${si+1}e${ei+1}`;
              ep.__seriesId=t.id; ep.__seasonIndex=si; ep.__epIndex=ei;
              byId.set(ep.id,ep);
            });
          });
        }
      });

      return { titles, byId };
    }

    async function loadData(){
      renderLoading();
      state.catalog = await fetchCatalogFromManifest();
      const norm = normalizeCatalog(state.catalog);
      state.titles = norm.titles;
      state.byId = norm.byId;
      initLoopQueue();
      render();
    }

    // ---------- Supabase optional ----------
    function loadScript(src){
      return new Promise((resolve,reject)=>{
        if([...document.scripts].some(s=>s.src===src)) return resolve();
        const s=document.createElement("script");
        s.src=src; s.onload=resolve; s.onerror=reject;
        document.head.appendChild(s);
      });
    }

    async function initSupabaseIfPossible(){
      if(!CONFIG.SUPABASE_URL || !CONFIG.SUPABASE_ANON_KEY) return;
      await loadScript("https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2");
      supabase = window.supabase?.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
      if(!supabase) return;

      const { data } = await supabase.auth.getSession();
      state.session = data.session || null;
      state.user = data.session?.user || null;

      supabase.auth.onAuthStateChange((_e,session)=>{
        state.session=session;
        state.user=session?.user||null;
        render();
      });
    }

    async function signIn(email,password){
      if(!supabase) return alert("Auth not configured.");
      const { error } = await supabase.auth.signInWithPassword({ email,password });
      if(error) alert(error.message);
    }
    async function signUp(email,password,fullName){
      if(!supabase) return alert("Auth not configured.");
      const { error } = await supabase.auth.signUp({
        email,password, options:{ data:{ full_name:fullName||"" } }
      });
      if(error) alert(error.message);
      else alert("Check email to confirm account.");
    }
    async function signOut(){
      if(!supabase) return;
      await supabase.auth.signOut();
    }

    // =========================================================
    // PayPal TVOD -> user_subscriptions (same as website)
    // =========================================================
    async function loadPayPalSDK(){
      if(!CONFIG.PAYPAL_CLIENT_ID) throw new Error("Missing PAYPAL_CLIENT_ID.");
      if(window.paypal) return;
      const src = `https://www.paypal.com/sdk/js?client-id=${encodeURIComponent(CONFIG.PAYPAL_CLIENT_ID)}&currency=${encodeURIComponent(CONFIG.PAYPAL_CURRENCY||"USD")}`;
      await loadScript(src);
    }

    function tvodPrices(t){
      const tvod=t.monetization?.tvod||{};
      return {
        enabled: !!tvod.enabled,
        rentPrice: Number(tvod.rentPrice || tvod.priceRent || tvod.price || 3.99),
        buyPrice: Number(tvod.buyPrice || tvod.priceBuy || 9.99),
        rentHours: Number(tvod.rentDurationHours || tvod.rentHours || 48)
      };
    }

    async function ensureTVODStatus(titleId){
      if(!supabase || !state.user) return { hasAccess:false, sub:null };
      const { data, error } = await supabase
        .from("user_subscriptions")
        .select("*")
        .eq("user_id", state.user.id)
        .eq("title_id", titleId)
        .order("created_at",{ascending:false})
        .limit(1);

      if(error){ console.warn(error.message); return {hasAccess:false,sub:null}; }
      const sub=data?.[0]||null;
      if(!sub) return {hasAccess:false,sub:null};

      if(sub.status==="rent" && sub.expires_at && new Date(sub.expires_at).getTime()<=Date.now()){
        await supabase.from("user_subscriptions").update({status:"expired"}).eq("id",sub.id);
        return {hasAccess:false,sub:{...sub,status:"expired"}};
      }
      if(sub.status==="buy") return {hasAccess:true,sub};
      if(sub.status==="rent" && (!sub.expires_at || new Date(sub.expires_at).getTime()>Date.now()))
        return {hasAccess:true,sub};

      return {hasAccess:false,sub};
    }

    async function openTVODModal(t){
      if(!supabase) return alert("TVOD requires Supabase configured.");
      if(!state.user) return navTo("#/login?mode=login");
      const prices=tvodPrices(t);
      if(!prices.enabled) return;

      await loadPayPalSDK();

      const modal=document.createElement("div");
      modal.className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4";
      modal.innerHTML=`
        <div class="w-full max-w-md rounded-2xl bg-watchBlack border border-white/10 p-4 space-y-3">
          <div class="text-xl font-bold">Rent / Buy</div>
          <div class="text-white/70 text-sm">${esc(t.title||"Untitled")}</div>

          <div class="grid grid-cols-2 gap-2 text-sm">
            <div class="p-3 rounded-xl bg-white/5 border border-white/10">
              <div class="font-semibold">Rent</div>
              <div class="text-white/70">$${prices.rentPrice.toFixed(2)} • ${prices.rentHours}h access</div>
              <div id="paypalRentBtn" class="mt-2"></div>
            </div>

            <div class="p-3 rounded-xl bg-white/5 border border-white/10">
              <div class="font-semibold">Buy</div>
              <div class="text-white/70">$${prices.buyPrice.toFixed(2)} • Unlimited</div>
              <div id="paypalBuyBtn" class="mt-2"></div>
            </div>
          </div>

          <button id="closeTVOD" class="w-full px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20">Cancel</button>
        </div>`;
      document.body.appendChild(modal);
      modal.querySelector("#closeTVOD").onclick=()=>modal.remove();
      modal.addEventListener("click",(e)=>{ if(e.target===modal) modal.remove(); });

      paypal.Buttons({
        style:{layout:"vertical",label:"rent",shape:"rect"},
        createOrder:(d,a)=>a.order.create({
          purchase_units:[{description:`WatchVIM Rent — ${t.title||t.id}`,amount:{currency_code:CONFIG.PAYPAL_CURRENCY||"USD",value:prices.rentPrice.toFixed(2)}}]
        }),
        onApprove:async(d,a)=>{
          const details=await a.order.capture();
          const expiresAt=new Date(Date.now()+prices.rentHours*3600*1000).toISOString();
          const { error }=await supabase.from("user_subscriptions").insert({
            user_id: state.user.id, title_id:t.id, status:"rent",
            provider:"paypal", order_id: details?.id||d.orderID,
            currency: CONFIG.PAYPAL_CURRENCY||"USD", amount:prices.rentPrice,
            expires_at: expiresAt
          });
          if(error) return alert(error.message);
          modal.remove(); navTo(`#/watch/${t.id}?kind=content`);
        }
      }).render("#paypalRentBtn");

      paypal.Buttons({
        style:{layout:"vertical",label:"buynow",shape:"rect"},
        createOrder:(d,a)=>a.order.create({
          purchase_units:[{description:`WatchVIM Buy — ${t.title||t.id}`,amount:{currency_code:CONFIG.PAYPAL_CURRENCY||"USD",value:prices.buyPrice.toFixed(2)}}]
        }),
        onApprove:async(d,a)=>{
          const details=await a.order.capture();
          const { error }=await supabase.from("user_subscriptions").insert({
            user_id: state.user.id, title_id:t.id, status:"buy",
            provider:"paypal", order_id: details?.id||d.orderID,
            currency: CONFIG.PAYPAL_CURRENCY||"USD", amount:prices.buyPrice,
            expires_at: null
          });
          if(error) return alert(error.message);
          modal.remove(); navTo(`#/watch/${t.id}?kind=content`);
        }
      }).render("#paypalBuyBtn");
    }

    // ---------- Router ----------
    function parseHash(){
      const raw=location.hash.replace(/^#\/?/,"");
      const [path,qs]=raw.split("?");
      const parts=(path||"home").split("/").filter(Boolean);
      const query=Object.fromEntries(new URLSearchParams(qs||""));

      if(parts[0]==="title" && parts[1]) return {name:"title",params:{id:parts[1]}};
      if(parts[0]==="series"&& parts[1]) return {name:"series",params:{id:parts[1]}};
      if(parts[0]==="episode"&&parts[1]&&parts[2]&&parts[3]){
        return {name:"episode",params:{seriesId:parts[1],seasonIndex:parts[2],epIndex:parts[3],kind:query.kind||"content"}};
      }
      if(parts[0]==="watch"&&parts[1]) return {name:"watch",params:{id:parts[1],kind:query.kind||"content"}};
      if(parts[0]==="loop") return {name:"loop",params:{}};
      if(parts[0]==="login") return {name:"login",params:{mode:query.mode||"login"}};
      if(parts[0]==="profile") return {name:"profile",params:{}};
      if(parts[0]==="search") return {name:"search",params:{}};
      return {name:"home",params:{}};
    }

    function setTab(tab){
      state.activeTab=tab;
      tab==="LIVE" ? navTo("#/loop") : navTo("#/home");
    }

    // ---------- Header / Shell (matches website) ----------
    function Header(){
      const loggedIn=!!state.user;
      const tabs=["Movies","Series","Shorts","Foreign","LIVE"];
      return `
        <header class="sticky top-0 z-50 bg-watchBlack/95 backdrop-blur border-b border-white/10 safe-bottom">
          <div class="px-4 py-3 flex items-center justify-between gap-3">
            <div class="flex items-center gap-3 cursor-pointer" onclick="navTo('#/home')">
              <img src="${CONFIG.LOGO_URL}" alt="WatchVIM" class="h-8 w-auto object-contain"/>
            </div>

            <nav class="flex items-center gap-2 text-sm">
              ${tabs.map(tab=>`
                <button class="tv-focus px-3 py-1.5 rounded-full ${
                  state.activeTab===tab?"bg-white/15 text-white":"text-white/70 hover:bg-white/10"
                }" onclick="setTab('${tab}')">${tab}</button>
              `).join("")}
              <button class="tv-focus px-3 py-1.5 rounded-full ${
                state.route.name==="search"?"bg-white/15 text-white":"text-white/70 hover:bg-white/10"
              }" onclick="navTo('#/search')">Search</button>
            </nav>

            <div class="flex items-center gap-2 text-sm">
              ${
                loggedIn ? `
                  <button class="tv-focus px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20" onclick="navTo('#/profile')">Profile</button>
                  <button class="tv-focus px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20" onclick="signOut()">Log out</button>
                ` : `
                  <button class="tv-focus px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20" onclick="navTo('#/login?mode=login')">Log in</button>
                `
              }
            </div>
          </div>
        </header>`;
    }

    function mobileTabBar(){
      if(isTV()) return "";
      const items=[["Movies","Movies"],["Series","Series"],["Shorts","Shorts"],["Foreign","Foreign"],["LIVE","LIVE"]];
      return `
        <footer class="fixed bottom-0 left-0 right-0 bg-black/95 border-t border-white/10 safe-bottom">
          <div class="flex justify-around px-2 py-2">
            ${items.map(([r,l])=>{
              const on=state.activeTab.toLowerCase()===r.toLowerCase();
              return `<button class="tv-focus flex-1 mx-1 py-2 rounded-lg text-xs ${on?"bg-white text-black":"bg-white/10"}"
                onclick="setTab('${r}')">${l}</button>`;
            }).join("")}
          </div>
        </footer>`;
    }

    function shell(pageHTML){
      const app=$app();
      app.innerHTML=`
        ${Header()}
        <div class="min-h-[calc(100vh-64px)] bg-watchBlack px-3 md:px-8 pb-24 md:pb-8">
          ${pageHTML}
        </div>
        ${mobileTabBar()}
        <footer class="px-4 md:px-8 py-6 text-xs text-white/50 border-t border-white/10">
          © WatchVIM — Powered by VIM Media
        </footer>`;
      if(isTV()) tvFocusReset();
      window.scrollTo(0,0);
    }

    // ---------- Hero / Rows (same layout as website) ----------
    function HeroRow(items){
      if(!items.length) return "";
      const t=items[0];
      const img=hero(t);
      const hasTrailer=!!t.trailerPlaybackId;

      return `
        <section class="relative w-full overflow-hidden rounded-2xl mt-3">
          <div class="aspect-video md:aspect-[21/9] bg-black relative">
            ${
              hasTrailer ? `
                <mux-player id="heroTrailerPlayer" stream-type="on-demand"
                  playback-id="${esc(t.trailerPlaybackId)}"
                  class="w-full h-full object-cover opacity-90"
                  muted autoplay loop playsinline></mux-player>
              ` : img ? `<img src="${img}" class="w-full h-full object-cover opacity-90"/>` : ""
            }
            <div class="absolute inset-0 bg-gradient-to-t from-watchBlack via-watchBlack/40 to-transparent"></div>
          </div>

          <div class="absolute left-0 right-0 bottom-0 p-4 md:p-8">
            <div class="max-w-3xl space-y-2">
              <div class="text-xs uppercase tracking-widest text-watchGold/90">${typeLabel(t.type)}</div>
              <h1 class="text-2xl md:text-4xl font-black">${esc(t.title||"Untitled")}</h1>
              <p class="text-white/80 line-clamp-3">${esc(t.synopsis||"")}</p>

              <div class="flex flex-wrap gap-2 text-xs text-white/70">
                ${t.releaseYear?`<span class="px-2 py-1 rounded bg-white/10">${esc(t.releaseYear)}</span>`:""}
                ${toMins(t.runtimeMins)?`<span class="px-2 py-1 rounded bg-white/10">${toMins(t.runtimeMins)} mins</span>`:""}
                ${(t.genre||[]).slice(0,4).map(g=>`<span class="px-2 py-1 rounded bg-white/10">${esc(g)}</span>`).join("")}
              </div>

              <div class="pt-2 flex gap-2">
                <button class="tv-focus px-4 py-2 rounded-lg bg-watchRed font-bold hover:opacity-90"
                  onclick="navTo('#/${t.type==="series"?"series":"title"}/${t.id}')">View</button>
                ${t.trailerPlaybackId?`
                  <button class="tv-focus px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20"
                    onclick="navTo('#/watch/${t.id}?kind=trailer')">Play Trailer</button>`:""}
              </div>
            </div>
          </div>
        </section>`;
    }

    function Card(t){
      const img=poster(t);
      const href=t.type==="series"?`#/series/${t.id}`:`#/title/${t.id}`;
      return `
        <button class="tv-focus min-w-[140px] md:min-w-[170px] text-left" onclick="navTo('${href}')">
          <div class="aspect-[2/3] rounded-xl overflow-hidden bg-white/5 border border-white/10">
            ${img?`<img src="${img}" class="w-full h-full object-cover"/>`:""}
          </div>
          <div class="mt-2 text-sm font-semibold line-clamp-2">${esc(t.title||"Untitled")}</div>
          <div class="text-xs text-white/60">${typeLabel(t.type)}</div>
        </button>`;
    }

    function Row(title,items){
      if(!items.length) return "";
      return `
        <section class="mt-6 space-y-2">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-bold">${esc(title)}</h2>
            <button class="tv-focus text-xs text-white/60 hover:text-white" onclick="navTo('#/tab/${esc(title)}')">See all</button>
          </div>
          <div class="flex gap-3 overflow-x-auto pb-2 no-scrollbar">
            ${items.map(Card).join("")}
          </div>
        </section>`;
    }

    // ---------- Home / Tab / Pages ----------
    function HomePage(){
      const filtered=state.titles.filter(TAB_FILTERS[state.activeTab]||(()=>true));
      const heroItems=filtered.slice(0,1);
      const lastWatched=readLastWatched().map(x=>state.byId.get(x.titleId)).filter(Boolean);

      const byGenre={};
      filtered.forEach(t=>{
        (t.genre||["Featured"]).forEach(g=>{
          const key=g||"Featured";
          byGenre[key]=byGenre[key]||[];
          byGenre[key].push(t);
        });
      });

      const genreRows=Object.entries(byGenre).slice(0,8)
        .map(([g,items])=>Row(g,items.slice(0,20))).join("");

      return `
        ${HeroRow(heroItems)}
        <div class="py-6 space-y-6">
          ${lastWatched.length?Row("Continue Watching",lastWatched.slice(0,12)):""}
          ${Row(`Top ${state.activeTab}`,filtered.slice(0,20))}
          ${genreRows}
        </div>`;
    }

    function TabPage(tab){
      const items=state.titles.filter(TAB_FILTERS[tab]||(()=>true));
      return `
        <h2 class="text-2xl font-semibold mt-4">${esc(tab)}</h2>
        <div class="grid grid-cols-2 md:grid-cols-6 gap-3 mt-4">
          ${items.map(t=>`
            <button class="tv-focus text-left" onclick="navTo('#/${t.type==="series"?"series":"title"}/${t.id}')">
              <div class="rounded-xl overflow-hidden bg-white/5 border border-white/10">
                <img src="${poster(t)}" class="w-full aspect-[2/3] object-cover"/>
              </div>
              <div class="mt-2 text-sm line-clamp-1">${esc(t.title||"Untitled")}</div>
            </button>`).join("")}
        </div>`;
    }

    function CreditsBlock(t){
      const actors=(t.actors||t.cast||[]).join?.(", ")||t.actors||t.cast||"";
      const director=(t.director||t.directors||"").toString();
      const writers=(t.writers||t.writer||[]).join?.(", ")||t.writers||t.writer||"";
      const imdb=t.imdbRating||t.ratings?.imdb||"";
      const rt=t.rottenTomatoesRating||t.ratings?.rottenTomatoes||"";
      if(!actors&&!director&&!writers&&!imdb&&!rt) return "";
      return `
        <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
          ${actors?`<div><div class="text-xs text-white/60">Actors</div><div>${esc(actors)}</div></div>`:""}
          ${director?`<div><div class="text-xs text-white/60">Director</div><div>${esc(director)}</div></div>`:""}
          ${writers?`<div><div class="text-xs text-white/60">Writers</div><div>${esc(writers)}</div></div>`:""}
          ${(imdb||rt)?`
            <div class="flex gap-2 items-end">
              ${imdb?`<span class="px-2 py-1 rounded bg-white/10 text-xs">IMDb: <b>${esc(imdb)}</b></span>`:""}
              ${rt?`<span class="px-2 py-1 rounded bg-white/10 text-xs">Rotten Tomatoes: <b>${esc(rt)}</b></span>`:""}
            </div>`:""}
        </div>`;
    }

    function renderWatchCTA(t){
      const monet=t.monetization||{};
      const tvod=monet.tvod||{};
      const canWatch=monet.svod||monet.avod||!tvod.enabled;

      if(tvod.enabled && !state.user)
        return `<button class="tv-focus px-4 py-2 rounded-lg bg-watchRed font-bold" onclick="navTo('#/login?mode=login')">Log in to Rent/Buy</button>`;
      if(tvod.enabled && state.user)
        return `<button class="tv-focus px-4 py-2 rounded-lg bg-watchRed font-bold hover:opacity-90" onclick="openTVODModal(state.byId.get('${t.id}'))">Rent / Buy</button>`;
      if(canWatch)
        return `<button class="tv-focus px-4 py-2 rounded-lg bg-watchRed font-bold hover:opacity-90" onclick="navTo('#/watch/${t.id}?kind=content')">Watch Now</button>`;
      return "";
    }

    function TitlePage(id){
      const t=state.byId.get(id);
      if(!t) return NotFound("Title not found");

      const img=hero(t);
      const monet=t.monetization||{};
      const tvod=monet.tvod||{};
      const accessBadge=[monet.svod?"SVOD":null, monet.avod?"AVOD":null, tvod.enabled?"TVOD":null].filter(Boolean).join(" • ");

      return `
        <section class="relative">
          <div class="aspect-video bg-black rounded-2xl overflow-hidden">
            ${img?`<img src="${img}" class="w-full h-full object-cover opacity-90"/>`:""}
            <div class="absolute inset-0 bg-gradient-to-t from-watchBlack via-watchBlack/40 to-transparent"></div>
          </div>

          <div class="p-4 md:p-8 -mt-10 md:-mt-20 relative z-10">
            <div class="max-w-4xl space-y-3">
              <button class="tv-focus text-xs text-white/70 hover:text-white" onclick="history.back()">← Back</button>

              <div class="flex flex-wrap gap-2 text-xs text-white/70">
                <span class="px-2 py-1 rounded bg-white/10">${typeLabel(t.type)}</span>
                ${t.releaseYear?`<span class="px-2 py-1 rounded bg-white/10">${esc(t.releaseYear)}</span>`:""}
                ${toMins(t.runtimeMins)?`<span class="px-2 py-1 rounded bg-white/10">${toMins(t.runtimeMins)} mins</span>`:""}
                ${accessBadge?`<span class="px-2 py-1 rounded bg-watchGold/20 text-watchGold">${accessBadge}</span>`:""}
              </div>

              <h1 class="text-2xl md:text-4xl font-black">${esc(t.title||"Untitled")}</h1>
              <p class="text-white/80">${esc(t.synopsis||"")}</p>
              ${CreditsBlock(t)}

              <div class="flex flex-wrap gap-2 pt-2">
                ${t.trailerPlaybackId?`
                  <button class="tv-focus px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20"
                    onclick="navTo('#/watch/${t.id}?kind=trailer')">Play Trailer</button>`:""}
                ${renderWatchCTA(t)}
              </div>
            </div>
          </div>
        </section>`;
    }

    function SeriesPage(id){
      const s=state.byId.get(id);
      if(!s||s.type!=="series") return NotFound("Series not found");
      const img=hero(s);

      return `
        <section class="relative">
          <div class="aspect-video bg-black rounded-2xl overflow-hidden">
            ${img?`<img src="${img}" class="w-full h-full object-cover opacity-90"/>`:""}
            <div class="absolute inset-0 bg-gradient-to-t from-watchBlack via-watchBlack/40 to-transparent"></div>
          </div>

          <div class="p-4 md:p-8 -mt-10 md:-mt-20 relative z-10">
            <div class="max-w-5xl space-y-3">
              <button class="tv-focus text-xs text-white/70 hover:text-white" onclick="history.back()">← Back</button>
              <div class="text-xs uppercase tracking-widest text-watchGold/90">Series</div>
              <h1 class="text-2xl md:text-4xl font-black">${esc(s.title||"Untitled")}</h1>
              <p class="text-white/80">${esc(s.synopsis||"")}</p>
              ${CreditsBlock(s)}

              <div class="pt-6 space-y-5">
                ${(s.seasons||[]).map((season,si)=>SeasonBlock(s,season,si)).join("") ||
                  `<div class="text-white/60 text-sm">No seasons published yet.</div>`}
              </div>
            </div>
          </div>
        </section>`;
    }

    function SeasonBlock(series,season,seasonIndex){
      const eps=season.episodes||[];
      return `
        <div class="space-y-2">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-bold">Season ${season.seasonNumber||seasonIndex+1}</h2>
            <div class="text-xs text-white/60">${eps.length} episodes</div>
          </div>
          <div class="space-y-2">
            ${eps.map((ep,ei)=>EpisodeRow(series,ep,seasonIndex,ei)).join("")}
          </div>
        </div>`;
    }

    function EpisodeRow(series,ep,seasonIndex,epIndex){
      const img=ep.thumbnailUrl||poster(series)||"";
      return `
        <div class="flex gap-3 p-2 rounded-lg bg-white/5 border border-white/10">
          <img src="${img}" class="w-20 h-28 object-cover rounded-md bg-black/40"/>
          <div class="flex-1 space-y-1">
            <div class="text-sm font-semibold">
              E${ep.episodeNumber||epIndex+1} — ${esc(ep.title||"Untitled")}
            </div>
            <div class="text-xs text-white/60 line-clamp-2">${esc(ep.synopsis||"")}</div>
            <div class="flex gap-2 pt-1">
              ${ep.trailerPlaybackId?`
                <button class="tv-focus px-3 py-1.5 text-xs rounded bg-white/10 hover:bg-white/20"
                  onclick="navTo('#/episode/${series.id}/${seasonIndex}/${epIndex}?kind=trailer')">Trailer</button>`:""}
              <button class="tv-focus px-3 py-1.5 text-xs rounded bg-watchRed font-bold"
                onclick="navTo('#/episode/${series.id}/${seasonIndex}/${epIndex}?kind=content')">Watch</button>
            </div>
          </div>
        </div>`;
    }

    function EpisodeWatchPage(seriesId,seasonIndex,epIndex,kind="content"){
      const s=state.byId.get(seriesId);
      const season=s?.seasons?.[Number(seasonIndex)];
      const ep=season?.episodes?.[Number(epIndex)];
      if(!s||!ep) return NotFound("Episode not found");

      const pb=kind==="trailer"?ep.trailerPlaybackId:ep.contentPlaybackId;
      if(!pb) return `
        <div class="p-6 space-y-3">
          <button class="tv-focus text-xs text-white/70 hover:text-white" onclick="history.back()">← Back</button>
          <div class="text-white/70">No ${kind} playback ID set for this episode.</div>
        </div>`;

      setTimeout(()=>markWatched(seriesId,0),0);

      return `
        <div class="p-4 md:p-8 space-y-4">
          <button class="tv-focus text-xs text-white/70 hover:text-white" onclick="history.back()">← Back</button>
          <div class="text-xl font-bold">
            ${esc(s.title)} — S${season.seasonNumber||Number(seasonIndex)+1}E${ep.episodeNumber||Number(epIndex)+1}
          </div>
          ${CreditsBlock(ep)}
          <div class="aspect-video bg-black rounded-xl overflow-hidden border border-white/10">
            <mux-player stream-type="on-demand" playback-id="${esc(pb)}" class="w-full h-full" controls autoplay></mux-player>
          </div>
        </div>`;
    }

    async function WatchPage(id,kind="content"){
      const t=state.byId.get(id);
      if(!t) return NotFound("Title not found");

      const pb=kind==="trailer"?t.trailerPlaybackId:t.contentPlaybackId;
      if(!pb) return `
        <div class="p-6 space-y-3">
          <button class="tv-focus text-xs text-white/70 hover:text-white" onclick="history.back()">← Back</button>
          <div class="text-white/70">No ${kind} playback ID set for this title.</div>
        </div>`;

      if(kind==="content" && t.monetization?.tvod?.enabled){
        const { hasAccess } = await ensureTVODStatus(t.id);
        if(!hasAccess){
          return `
            <div class="p-6 space-y-3">
              <button class="tv-focus text-xs text-white/70 hover:text-white" onclick="history.back()">← Back</button>
              <div class="text-xl font-bold">${esc(t.title||"Untitled")}</div>
              <div class="text-white/70">This title is TVOD. Rent or Buy to watch.</div>
              <button class="tv-focus px-4 py-2 rounded-lg bg-watchRed font-bold w-fit"
                onclick="openTVODModal(state.byId.get('${t.id}'))">Rent / Buy</button>
            </div>`;
        }
      }

      setTimeout(()=>markWatched(id,0),0);

      return `
        <div class="p-4 md:p-8 space-y-4">
          <button class="tv-focus text-xs text-white/70 hover:text-white" onclick="history.back()">← Back</button>
          <div class="text-xl font-bold">${esc(t.title)}</div>
          ${CreditsBlock(t)}
          <div class="aspect-video bg-black rounded-xl overflow-hidden border border-white/10">
            <mux-player stream-type="on-demand" playback-id="${esc(pb)}" class="w-full h-full" controls autoplay></mux-player>
          </div>
        </div>`;
    }

    // ---------- Login / Profile ----------
    let loginView="login";
    function setLoginView(v){
      loginView=v==="signup"?"signup":"login";
      navTo(`#/login?mode=${loginView}`);
    }

    function LoginPage(){
      if(!supabase) return `
        <div class="p-6 max-w-md mx-auto space-y-3">
          <div class="text-2xl font-bold">Login</div>
          <div class="text-white/70 text-sm">Supabase isn’t configured yet.</div>
        </div>`;

      const isLogin=loginView==="login";
      return `
        <div class="p-6 max-w-md mx-auto space-y-5">
          <div class="text-2xl font-black">Welcome to WatchVIM</div>

          <div class="flex rounded-xl bg-white/5 border border-white/10 p-1 text-sm">
            <button class="tv-focus flex-1 py-2 rounded-lg ${isLogin?"bg-white/15":"hover:bg-white/10 text-white/70"}"
              onclick="setLoginView('login')">Log In</button>
            <button class="tv-focus flex-1 py-2 rounded-lg ${!isLogin?"bg-white/15":"hover:bg-white/10 text-white/70"}"
              onclick="setLoginView('signup')">Become a Member</button>
          </div>

          ${!isLogin?`
            <div class="space-y-2">
              <div class="text-xs text-white/60">Full Name</div>
              <input id="signupName" class="w-full px-3 py-2 rounded bg-white/5 border border-white/10" placeholder="Your name"/>
            </div>`:""}

          <div class="space-y-2">
            <div class="text-xs text-white/60">Email</div>
            <input id="loginEmail" class="w-full px-3 py-2 rounded bg-white/5 border border-white/10" placeholder="you@email.com"/>
          </div>

          <div class="space-y-2">
            <div class="text-xs text-white/60">Password</div>
            <input id="loginPass" type="password" class="w-full px-3 py-2 rounded bg-white/5 border border-white/10" placeholder="••••••••"/>
          </div>

          ${!isLogin?`
            <div class="space-y-2">
              <div class="text-xs text-white/60">Confirm Password</div>
              <input id="signupPass2" type="password" class="w-full px-3 py-2 rounded bg-white/5 border border-white/10" placeholder="••••••••"/>
            </div>`:""}

          <button class="tv-focus w-full px-4 py-2 rounded-lg bg-watchRed font-bold hover:opacity-90"
            onclick="${isLogin?"handleSignIn()":"handleSignUp()"}">
            ${isLogin?"Log In":"Create Account"}
          </button>
        </div>`;
    }

    function ProfilePage(){
      if(!supabase) return NotFound("Auth not configured.");
      if(!state.user) return `
        <div class="p-6 max-w-md mx-auto space-y-3">
          <div class="text-2xl font-bold">Profile</div>
          <div class="text-white/70">You’re not logged in.</div>
          <button class="tv-focus px-4 py-2 rounded bg-watchRed font-bold" onclick="navTo('#/login?mode=login')">Log in</button>
        </div>`;

      const lastWatched=readLastWatched().map(x=>state.byId.get(x.titleId)).filter(Boolean);

      return `
        <div class="p-6 max-w-3xl mx-auto space-y-4">
          <div class="text-2xl font-bold">Your Profile</div>
          <div class="bg-white/5 border border-white/10 rounded-xl p-4">
            <div class="text-sm text-white/60">Email</div>
            <div class="font-semibold">${esc(state.user.email)}</div>
          </div>
          ${lastWatched.length?`
            <div class="space-y-2">
              <div class="text-lg font-bold">Continue Watching</div>
              <div class="flex gap-3 overflow-x-auto pb-2 no-scrollbar">
                ${lastWatched.slice(0,12).map(Card).join("")}
              </div>
            </div>`:""}
        </div>`;
    }

    function SearchPage(){
      return `
        <section class="mt-4">
          <input id="searchInput" class="w-full px-4 py-3 rounded-xl bg-white/10 outline-none"
            placeholder="Search titles..." />
          <div id="searchResults" class="grid grid-cols-2 md:grid-cols-6 gap-3 mt-4"></div>
        </section>`;
    }

    function wireSearch(){
      const input=document.getElementById("searchInput");
      const results=document.getElementById("searchResults");
      if(!input||!results) return;

      function show(q){
        const filtered=(state.titles||[]).filter(t=>(t.title||"").toLowerCase().includes(q.toLowerCase()));
        results.innerHTML=filtered.map(t=>`
          <button class="tv-focus text-left" onclick="navTo('#/${t.type==="series"?"series":"title"}/${t.id}')">
            <div class="rounded-xl overflow-hidden bg-white/5 border border-white/10">
              <img src="${poster(t)}" class="w-full aspect-[2/3] object-cover"/>
            </div>
            <div class="mt-2 text-sm line-clamp-1">${esc(t.title||"Untitled")}</div>
          </button>`).join("");
        if(isTV()) tvFocusReset();
      }

      input.addEventListener("input",(e)=>show(e.target.value));
      show("");
    }

    function NotFound(msg="Not found"){
      return `
        <div class="p-6 text-center space-y-2">
          <div class="text-xl font-bold">${esc(msg)}</div>
          <button class="tv-focus px-4 py-2 rounded bg-white/10 hover:bg-white/20" onclick="navTo('#/home')">Go Home</button>
        </div>`;
    }

    // =========================================================
    // LIVE LOOP (same as website)
    // =========================================================
    function initLoopQueue(){
      const loop=state.catalog?.loopChannel;
      if(!loop || !(loop.rotationItems||[]).length){ state.loop.queue=[]; return; }
      const items=(loop.rotationItems||[]).map(resolveLoopItem).filter(Boolean);
      state.loop.queue=loop.shuffle?shuffleArray(items):items;
      state.loop.index=0; state.loop.lastAdAt=0; state.loop.shuffle=!!loop.shuffle; state.loop.playingAd=false;
    }

    function resolveLoopItem(it){
      if(!it) return null;
      const {refType,refId,label}=it;

      if(refType==="title"){
        const t=state.byId.get(refId); if(!t) return null;
        return {kind:"content",refType,refId,label:label||t.title||"Untitled",poster:poster(t),playbackId:t.contentPlaybackId||t.trailerPlaybackId||""};
      }
      if(refType==="episode"){
        const ep=state.byId.get(refId); if(!ep) return null;
        const series=state.byId.get(ep.__seriesId);
        return {
          kind:"content",refType,refId,
          label:label||`${series?.title||"Series"} — S${Number(ep.__seasonIndex)+1}E${Number(ep.__epIndex)+1} • ${ep.title||"Untitled"}`,
          poster:ep.thumbnailUrl||poster(series)||"",
          playbackId:ep.contentPlaybackId||ep.trailerPlaybackId||""
        };
      }
      return null;
    }

    function pickLoopAd(){
      const ads=state.catalog?.loopChannel?.sponsoredAds||[];
      if(!ads.length) return null;
      const ad=ads[Math.floor(Math.random()*ads.length)];
      return {kind:"ad",label:ad.name||"Sponsored",durationSec:ad.durationSec||15,playbackId:ad.muxAdPlaybackId||"",mediaUrl:ad.mediaUrl||"",clickUrl:ad.clickUrl||""};
    }

    function shouldPlayAd(){
      const freqMins=Number(state.catalog?.loopChannel?.adFrequencyMins||12);
      const elapsed=Date.now()-(state.loop.lastAdAt||0);
      return elapsed>=freqMins*60*1000;
    }

    function nextLoopItem(){
      if(!state.loop.queue.length) return null;
      state.loop.index=(state.loop.index+1)%state.loop.queue.length;
      if(state.loop.index===0 && state.loop.shuffle) state.loop.queue=shuffleArray(state.loop.queue);
      return state.loop.queue[state.loop.index];
    }

    function currentLoopItem(){ return state.loop.queue[state.loop.index]||null; }

    function LoopPage(){
      const loop=state.catalog?.loopChannel;
      const queue=state.loop.queue;
      if(!loop||!queue.length) return `
        <div class="p-6 md:p-8 space-y-3">
          <div class="text-2xl font-bold">LIVE</div>
          <div class="text-white/70">No LIVE rotation items are published yet.</div>
        </div>`;

      const now=currentLoopItem();
      const pb=now?.playbackId;

      return `
        <div class="p-4 md:p-8 space-y-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-2xl font-bold">LIVE</div>
              <div class="text-xs text-white/60">${loop.shuffle?"Shuffle On":"Shuffle Off"} • Ads every ${loop.adFrequencyMins||12} mins</div>
            </div>
            <div class="flex gap-2">
              <button class="tv-focus px-3 py-1.5 rounded bg-white/10 hover:bg-white/20 text-sm" onclick="toggleLoopShuffle()">
                ${state.loop.shuffle?"Disable Shuffle":"Enable Shuffle"}
              </button>
              <button class="tv-focus px-3 py-1.5 rounded bg-white/10 hover:bg-white/20 text-sm" onclick="skipLoop()">Next →</button>
            </div>
          </div>

          <div class="text-sm font-semibold">${esc(now?.label||"")}</div>
          ${pb?`
            <div class="aspect-video bg-black rounded-xl overflow-hidden border border-white/10">
              <mux-player id="loopPlayer" stream-type="on-demand" playback-id="${esc(pb)}" class="w-full h-full" controls autoplay></mux-player>
            </div>`:`
            <div class="p-6 rounded-xl bg-white/5 border border-white/10 text-white/70">No Playback ID. Skipping…</div>`}

          <div class="pt-2">
            <div class="text-xs text-white/60 mb-2">Up Next</div>
            <div class="flex gap-3 overflow-x-auto pb-2 no-scrollbar">
              ${queue.slice(0,12).map((q,i)=>`
                <div class="min-w-[150px]">
                  <div class="aspect-[2/3] rounded-lg overflow-hidden bg-white/5 border border-white/10">
                    ${q.poster?`<img src="${q.poster}" class="w-full h-full object-cover"/>`:""}
                  </div>
                  <div class="mt-1 text-xs line-clamp-2 ${i===state.loop.index?"text-watchGold":"text-white/80"}">${esc(q.label)}</div>
                </div>`).join("")}
            </div>
          </div>
        </div>`;
    }

    function attachLoopPlayerListeners(){
      const p=document.getElementById("loopPlayer");
      if(!p) return;
      if(!currentLoopItem()?.playbackId){ setTimeout(()=>playNextLoop(),500); return; }
      p.addEventListener("ended",playNextLoop);
      p.addEventListener("error",playNextLoop);
    }

    function renderLoopAd(ad){
      shell(`
        <div class="p-4 md:p-8 space-y-3">
          <div class="text-xs uppercase tracking-widest text-watchGold/90">Sponsored</div>
          <div class="text-lg font-bold">${esc(ad.label||"Ad")}</div>

          <div class="aspect-video bg-black rounded-xl overflow-hidden border border-white/10">
            ${ad.playbackId?`
              <mux-player id="loopAdPlayer" stream-type="on-demand" playback-id="${esc(ad.playbackId)}" class="w-full h-full" autoplay controls></mux-player>
            `:`
              <video id="loopAdPlayer" class="w-full h-full" autoplay controls>
                <source src="${esc(ad.mediaUrl)}" />
              </video>`}
          </div>

          ${ad.clickUrl?`<a class="text-sm text-watchGold underline" href="${esc(ad.clickUrl)}" target="_blank" rel="noreferrer">Learn more</a>`:""}
          <button class="tv-focus px-3 py-2 rounded bg-white/10 hover:bg-white/20 text-sm w-fit" onclick="playNextLoop()">Skip Ad →</button>
        </div>`);

      const p=document.getElementById("loopAdPlayer");
      p?.addEventListener("ended",()=>{state.loop.playingAd=false; render();});
      p?.addEventListener("error",()=>{state.loop.playingAd=false; render();});
    }

    function playNextLoop(){
      if(!state.loop.playingAd && shouldPlayAd()){
        const ad=pickLoopAd();
        if(ad && (ad.playbackId||ad.mediaUrl)){
          state.loop.playingAd=true;
          state.loop.lastAdAt=Date.now();
          renderLoopAd(ad);
          return;
        }
      }
      state.loop.playingAd=false;
      nextLoopItem();
      render();
    }

    window.skipLoop=()=>playNextLoop();
    window.toggleLoopShuffle=()=>{
      state.loop.shuffle=!state.loop.shuffle;
      initLoopQueue(); render();
    };

    // =========================================================
    // TV D-Pad Navigation
    // =========================================================
    let tvFocusIndex=0;
    function tvFocusable(){
      return Array.from(document.querySelectorAll(".tv-focus"))
        .filter(el=>!el.disabled && el.offsetParent!==null);
    }
    function tvFocusReset(){
      const items=tvFocusable(); if(!items.length) return;
      tvFocusIndex=0;
      items.forEach(i=>i.classList.remove("focus-ring"));
      items[0].classList.add("focus-ring");
      items[0].scrollIntoView({block:"nearest",inline:"nearest"});
    }
    function tvMove(delta){
      const items=tvFocusable(); if(!items.length) return;
      items[tvFocusIndex]?.classList.remove("focus-ring");
      tvFocusIndex=Math.max(0,Math.min(items.length-1,tvFocusIndex+delta));
      items[tvFocusIndex].classList.add("focus-ring");
      items[tvFocusIndex].scrollIntoView({block:"nearest",inline:"nearest"});
    }
    function tvActivate(){
      const items=tvFocusable(); const el=items[tvFocusIndex];
      el?.click();
    }
    window.addEventListener("keydown",(e)=>{
      if(!isTV()) return;
      switch(e.key){
        case "ArrowRight": tvMove(1); e.preventDefault(); break;
        case "ArrowLeft": tvMove(-1); e.preventDefault(); break;
        case "ArrowDown": tvMove(3); e.preventDefault(); break;
        case "ArrowUp": tvMove(-3); e.preventDefault(); break;
        case "Enter": tvActivate(); e.preventDefault(); break;
        case "Backspace":
        case "Escape":
          history.length>1 ? history.back() : navTo("#/home");
          e.preventDefault(); break;
      }
    });

    // =========================================================
    // MAIN RENDER
    // =========================================================
    function renderLoading(){
      shell(`
        <div class="min-h-screen flex flex-col items-center justify-center gap-4 bg-watchBlack">
          <div class="animate-pulse w-16 h-16 rounded-2xl bg-white/10"></div>
          <div class="text-white/70 text-sm">Loading WatchVIM…</div>
        </div>`);
    }

    async function render(){
      state.route=parseHash();
      const r=state.route;
      if(r.name==="login") loginView=r.params.mode==="signup"?"signup":"login";

      let page="";
      if(r.name==="home") page=HomePage();
      else if(r.name==="tab") page=TabPage(r.params?.tab||state.activeTab);
      else if(r.name==="title") page=TitlePage(r.params.id);
      else if(r.name==="series") page=SeriesPage(r.params.id);
      else if(r.name==="episode") page=EpisodeWatchPage(r.params.seriesId,r.params.seasonIndex,r.params.epIndex,r.params.kind);
      else if(r.name==="watch") page=await WatchPage(r.params.id,r.params.kind);
      else if(r.name==="loop") page=LoopPage();
      else if(r.name==="login") page=LoginPage();
      else if(r.name==="profile") page=ProfilePage();
      else if(r.name==="search") page=SearchPage();
      else page=HomePage();

      shell(page);
      if(r.name==="loop") attachLoopPlayerListeners();
      if(r.name==="search") wireSearch();
    }

    // global handlers
    window.navTo=navTo;
    window.setTab=setTab;
    window.signOut=signOut;
    window.setLoginView=setLoginView;
    window.openTVODModal=openTVODModal;

    window.handleSignIn=()=>{
      const email=document.getElementById("loginEmail")?.value.trim();
      const pass=document.getElementById("loginPass")?.value.trim();
      if(!email||!pass) return alert("Enter email + password.");
      signIn(email,pass);
    };
    window.handleSignUp=()=>{
      const name=document.getElementById("signupName")?.value.trim();
      const email=document.getElementById("loginEmail")?.value.trim();
      const pass=document.getElementById("loginPass")?.value.trim();
      const pass2=document.getElementById("signupPass2")?.value.trim();
      if(!name) return alert("Please enter your full name.");
      if(!email||!pass||!pass2) return alert("Fill out all fields.");
      if(pass!==pass2) return alert("Passwords do not match.");
      if(pass.length<6) return alert("Password must be at least 6 characters.");
      signUp(email,pass,name);
    };

    // boot
    (async function boot(){
      await loadConfigJSON();
      await initSupabaseIfPossible();
      await loadData();
      window.addEventListener("hashchange",render);
      render();
    })();
  })();
  </script>
</body>
</html>
